import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import requests
from sklearn.ensemble import RandomForestClassifier

# --- Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ (Î’Î¬Î»Îµ Ï„Î± Î´Î¹ÎºÎ¬ ÏƒÎ¿Ï… Î±Ï€ÏŒ BotFather & MyIDBot) ---
TELEGRAM_TOKEN = "7854097442:AAEGZTQ4bRZ2TttL1sLR4DhP_Xly8yGxMpQ"Â 
CHAT_ID = "5943916637"

def send_telegram(msg):
Â  Â  url = f"https://api.telegram.org{TELEGRAM_TOKEN}/sendMessage?chat_id={CHAT_ID}&text={msg}"
Â  Â  try: requests.get(url)
Â  Â  except: pass

st.set_page_config(page_title="AI Wealth Mentor 2026", layout="wide")
st.title("ğŸ›ï¸ AI Wealth Mentor & Simulator")

# --- 1. SIMULATION SYSTEM ---
if 'balance' not in st.session_state:
Â  Â  st.session_state.balance = 10000.0
Â  Â  st.session_state.portfolio = {}

# --- 2. Î•Î Î™Î›ÎŸÎ“Î— & Î‘ÎÎ‘Î›Î¥Î£Î— ---
ticker = st.sidebar.text_input("Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (Ï€.Ï‡. AAPL, NVDA, BTC-USD):", "NVDA")
stock = yf.Ticker(ticker)
hist = stock.history(period="1y")

if not hist.empty:
Â  Â  info = stock.info
Â  Â  price = info.get('currentPrice', hist['Close'].iloc[-1])
Â  Â Â 
Â  Â  # Î¤ÎµÏ‡Î½Î¹ÎºÎ¿Î¯ Î”ÎµÎ¯ÎºÏ„ÎµÏ‚
Â  Â  delta = hist['Close'].diff()
Â  Â  gain = (delta.where(delta > 0, 0)).rolling(14).mean()
Â  Â  loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
Â  Â  rsi = 100 - (100 / (1 + gain/loss)).iloc[-1]
Â  Â Â 
Â  Â  # Î˜ÎµÎ¼ÎµÎ»Î¹ÏÎ´Î·
Â  Â  debt_equity = info.get('debtToEquity', 0)
Â  Â  fcf = info.get('freeCashflow', 0)

Â  Â  # --- 3. Î ÎŸÎ¡Î¤ÎŸÎ¦ÎŸÎ›Î™ÎŸ & Î Î¡ÎŸÎ¤Î‘Î£Î— ---
Â  Â  st.header("ğŸ“‹ Î— Î ÏÏŒÏ„Î±ÏƒÎ· Ï„Î¿Ï… Mentor")
Â  Â  risk = "HIGH" if (rsi > 70 or debt_equity > 150) else "LOW"
Â  Â Â 
Â  Â  col1, col2 = st.columns(2)
Â  Â  with col1:
Â  Â  Â  Â  if risk == "LOW":
Â  Â  Â  Â  Â  Â  st.success("ğŸ¯ Î Î¡ÎŸÎ¤Î‘Î£Î—: Î‘Î“ÎŸÎ¡Î‘ (Growth Strategy)")
Â  Â  Â  Â  Â  Â  st.write("ÎšÎ±Ï„Î±Î½Î¿Î¼Î®: 70% ÎœÎµÏ„Î¿Ï‡Î­Ï‚ / 30% Peerberry")
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  st.warning("âš ï¸ Î Î¡ÎŸÎ¤Î‘Î£Î—: Î‘ÎœÎ¥ÎÎ‘ (Safety Strategy)")
Â  Â  Â  Â  Â  Â  st.write("ÎšÎ±Ï„Î±Î½Î¿Î¼Î®: 20% ÎœÎµÏ„Î¿Ï‡Î­Ï‚ / 80% Peerberry & ÎŸÎ¼ÏŒÎ»Î¿Î³Î±")
Â  Â  Â  Â  Â  Â Â 
Â  Â  with col2:
Â  Â  Â  Â  st.metric("Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î¤Î¹Î¼Î®", f"{price:.2f} $")
Â  Â  Â  Â  st.metric("Î”ÎµÎ¯ÎºÏ„Î·Ï‚ RSI (Î¤Î¬ÏƒÎ·)", f"{rsi:.1f}")

Â  Â  # --- 4. Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎ— Î‘ÎÎ‘Î›Î¥Î£Î— (Î“Î™Î‘Î¤Î™;) ---
Â  Â  with st.expander("ğŸ“– Î“Î¹Î±Ï„Î¯ Î±Ï…Ï„Î® Î· Ï€ÏÏŒÏ„Î±ÏƒÎ·; (Î‘Î½Î¬Î»Ï…ÏƒÎ· Mentor)"):
Â  Â  Â  Â  st.subheader("Î¤ÎµÏ‡Î½Î¹ÎºÎ® Î‘Î¹Ï„Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· (RSI)")
Â  Â  Â  Â  if rsi < 40: st.write("Î— Î¼ÎµÏ„Î¿Ï‡Î® ÎµÎ¯Î½Î±Î¹ 'Ï…Ï€Î¿Ï„Î¹Î¼Î·Î¼Î­Î½Î·'. ÎŸÎ¹ Ï€Ï‰Î»Î·Ï„Î­Ï‚ ÏƒÏ„Î±Î¼Î¬Ï„Î·ÏƒÎ±Î½ ÎºÎ±Î¹ Î· Î¶Î®Ï„Î·ÏƒÎ· Î±Î½Î±Î¼Î­Î½ÎµÏ„Î±Î¹ Î½Î± ÏƒÏ€ÏÏÎ¾ÎµÎ¹ Ï„Î·Î½ Ï„Î¹Î¼Î® Ï€Î¬Î½Ï‰.")
Â  Â  Â  Â  elif rsi > 70: st.write("Î— Î¼ÎµÏ„Î¿Ï‡Î® ÎµÎ¯Î½Î±Î¹ 'Ï…Ï€ÎµÏÎ¸ÎµÏÎ¼Î±ÏƒÎ¼Î­Î½Î·'. Î Î¿Î»Î»Î¿Î¯ Î±Î³ÏŒÏÎ±ÏƒÎ±Î½ Î±Ï€ÏŒÏ„Î¿Î¼Î± ÎºÎ±Î¹ ÏƒÏÎ½Ï„Î¿Î¼Î± Î¸Î± Ï€Î¿Ï…Î»Î®ÏƒÎ¿Ï…Î½ Î³Î¹Î± ÎºÎ­ÏÎ´Î¿Ï‚, Ï€ÏÎ¿ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ Ï€Ï„ÏÏƒÎ·.")
Â  Â  Â  Â Â 
Â  Â  Â  Â  st.subheader("ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® Î‘Î¹Ï„Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· (Debt)")
Â  Â  Â  Â  if debt_equity < 100: st.write("Î— ÎµÏ„Î±Î¹ÏÎµÎ¯Î± Î­Ï‡ÎµÎ¹ Î»Î¯Î³Î± Ï‡ÏÎ­Î·. Î¤Î¿ 2026 Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ 'ÎºÎ»ÎµÎ¹Î´Î¯', Î³Î¹Î±Ï„Î¯ Î´ÎµÎ½ ÎºÎ¹Î½Î´Ï…Î½ÎµÏÎµÎ¹ Î±Ï€ÏŒ Ï„Î± Ï…ÏˆÎ·Î»Î¬ ÎµÏ€Î¹Ï„ÏŒÎºÎ¹Î±.")
Â  Â  Â  Â  else: st.write("Î¤Î¿ Ï‡ÏÎ­Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…ÏˆÎ·Î»ÏŒ. Î— ÎµÏ„Î±Î¹ÏÎµÎ¯Î± Ï€Î»Î·ÏÏÎ½ÎµÎ¹ Ï€Î¿Î»Î»Î¿ÏÏ‚ Ï„ÏŒÎºÎ¿Ï…Ï‚, ÎºÎ¬Ï„Î¹ Ï€Î¿Ï… Î¼ÎµÎ¹ÏÎ½ÎµÎ¹ Ï„Î·Î½ Î±Î¾Î¯Î± Ï„Î·Ï‚ Î¼ÎµÏ„Î¿Ï‡Î®Ï‚ Ï„Î·Ï‚.")

Â  Â  # --- 5. Î”Î¡Î‘Î£Î— & SIMULATION ---
Â  Â  st.divider()
Â  Â  c1, c2, c3 = st.columns(3)
Â  Â  if c1.button("ğŸš€ Î•Ï€Î­Î½Î´Ï…ÏƒÎ· Revolut"): st.markdown("[Revolut Link](revolut://app/wealth)")
Â  Â  if c2.button("ğŸ“ˆ Peerberry (P2P)"): st.markdown("[Peerberry Link](https://peerberry.com)")
Â  Â  if c3.button("ğŸ“¢ Î£Ï„ÎµÎ¯Î»Îµ Alert ÏƒÏ„Î¿ Telegram"):Â 
Â  Â  Â  Â  send_telegram(f"Alert Î³Î¹Î± {ticker}: Î¤Î¹Î¼Î® {price}$. RSI: {rsi:.1f}. Î ÏÏŒÏ„Î±ÏƒÎ·: {risk}")

Â  Â  # Simulation Trading
Â  Â  st.subheader("ğŸ® Simulation Trading")
Â  Â  qty = st.number_input("Î Î¿ÏƒÏŒÏ„Î·Ï„Î±:", min_value=1)
Â  Â  if st.button("Î•Î¹ÎºÎ¿Î½Î¹ÎºÎ® Î‘Î³Î¿ÏÎ¬"):
Â  Â  Â  Â  cost = qty * price
Â  Â  Â  Â  if st.session_state.balance >= cost:
Â  Â  Â  Â  Â  Â  st.session_state.balance -= cost
Â  Â  Â  Â  Â  Â  st.session_state.portfolio[ticker] = st.session_state.portfolio.get(ticker, 0) + qty
Â  Â  Â  Â  Â  Â  st.success("Î— Î±Î³Î¿ÏÎ¬ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ ÏƒÏ„Î¿ simulation!")
Â  Â  Â  Â  else: st.error("Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î±ÏÎºÎµÏ„Î¬ ÎµÎ¹ÎºÎ¿Î½Î¹ÎºÎ¬ Ï‡ÏÎ®Î¼Î±Ï„Î±!")

Â  Â  st.sidebar.metric("Î•Î¹ÎºÎ¿Î½Î¹ÎºÏŒ ÎšÎµÏ†Î¬Î»Î±Î¹Î¿", f"{st.session_state.balance:.2f} $")
Â  Â  st.sidebar.write("ğŸ“¦ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹:", st.session_state.portfolio)